<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Qu·∫£n l√Ω Chi ti√™u</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
  <link rel="stylesheet" href="/css/main.css">
  <link rel="stylesheet" href="/css/dashboard.css">
</head>
<body class="bg-light">
  <div class="container py-4">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
      <h4 class="mb-0 fw-bold">Chi ti√™u h√†ng ng√†y</h4>
      <div>
        <button id="logout-btn" class="btn btn-outline-secondary btn-sm me-2">
          <i class="bi bi-box-arrow-right"></i> ƒêƒÉng xu·∫•t
        </button>
        <button class="btn btn-outline-secondary btn-sm">
          <i class="bi bi-calendar3"></i> Th√°ng 4, 2025
        </button>
      </div>
    </div>

    <div class="row g-4">
      <!-- Left Column -->
      <div class="col-lg-8">
        <!-- Add Expense Form -->
        <div class="card mb-4">
          <div class="card-body">
            <form id="expense-form" class="row g-3">
              <div class="col-md-4">
                <label class="form-label">S·ªë ti·ªÅn</label>
                <div class="input-group">
                  <span class="input-group-text"><i class="bi bi-currency-dollar"></i></span>
                  <input type="number" id="amount" class="form-control" required>
                </div>
              </div>
              <div class="col-md-4">
                <label class="form-label">M√¥ t·∫£</label>
                <input type="text" id="description" class="form-control" required>
              </div>
              <div class="col-md-4">
                <label class="form-label">Ng√†y</label>
                <input type="date" id="date" class="form-control" required>
              </div>
              <div class="col-md-12">
                <label class="form-label">Danh m·ª•c</label>
                <select id="categoryId" class="form-select">
                  <option value="">-- Ch·ªçn danh m·ª•c --</option>
                  <!-- Categories will be loaded here -->
                </select>
              </div>
              <div class="col-12">
                <button type="submit" class="btn btn-primary">
                  <i class="bi bi-plus-circle me-1"></i>
                  Th√™m chi ti√™u
                </button>
              </div>
            </form>
          </div>
        </div>

        <!-- Expenses Table -->
        <div class="card">
          <div class="card-body p-0">
            <div class="table-responsive">
              <table class="table table-hover align-middle mb-0">
                <thead class="bg-light">
                  <tr>
                    <th class="ps-4">M√¥ t·∫£</th>
                    <th>Danh m·ª•c</th>
                    <th>Ng√†y</th>
                    <th class="text-end">S·ªë ti·ªÅn</th>
                    <th width="100" class="text-center">Thao t√°c</th>
                  </tr>
                </thead>
                <tbody id="expense-list">
                  <!-- Expenses will be listed here -->
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

      <!-- Right Column -->
      <div class="col-lg-4">
        <!-- Summary Card -->
        <div class="card summary-card mb-4">
          <div class="card-body">
            <h6 class="text-white-50 mb-2">T·ªïng chi th√°ng n√†y</h6>
            <div id="total-amount" class="amount mb-2">0ƒë</div>
            <small class="text-white-50">C·∫≠p nh·∫≠t l√∫c <%= new Date().toLocaleTimeString('vi-VN') %></small>
          </div>
        </div>
        
        <!-- Category Management -->
        <div class="card mb-4">
          <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="card-title mb-0">Danh m·ª•c chi ti√™u</h5>
            <button id="add-category-btn" class="btn btn-sm btn-primary">
              <i class="bi bi-plus"></i> Th√™m m·ªõi
            </button>
          </div>
          <div class="card-body p-0">
            <ul id="category-list" class="list-group list-group-flush">
              <!-- Categories will be loaded here -->
            </ul>
          </div>
          <div class="card-footer text-center">
            <button id="add-default-categories" class="btn btn-sm btn-outline-secondary">
              <i class="bi bi-arrow-repeat"></i> T·∫°o danh m·ª•c m·∫∑c ƒë·ªãnh
            </button>
          </div>
        </div>
        
        <!-- Budget Management -->
        <div class="card mb-4">
          <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="card-title mb-0">Ng√¢n s√°ch</h5>
            <button id="add-budget-btn" class="btn btn-sm btn-primary">
              <i class="bi bi-plus"></i> Th√™m m·ªõi
            </button>
          </div>
          <div class="card-body p-0">
            <div id="budget-list" class="list-group list-group-flush">
              <!-- Budgets will be loaded here -->
            </div>
          </div>
        </div>
        
        <!-- Income Management -->
        <div class="card mb-4">
          <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="card-title mb-0">Thu nh·∫≠p</h5>
            <button id="add-income-btn" class="btn btn-sm btn-primary">
              <i class="bi bi-plus"></i> Th√™m m·ªõi
            </button>
          </div>
          <div class="card-body p-0">
            <div id="income-list" class="list-group list-group-flush">
              <!-- Incomes will be loaded here -->
            </div>
          </div>
        </div>
        
        <!-- Balance Summary -->
        <div class="card mb-4">
          <div class="card-header">
            <h5 class="card-title mb-0">C√¢n ƒë·ªëi thu - chi</h5>
          </div>
          <div class="card-body p-0">
            <div id="balance-summary" class="p-3">
              <!-- Balance summary will be loaded here -->
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Edit Expense Modal -->
  <div class="modal fade" id="editExpenseModal" tabindex="-1" aria-labelledby="editExpenseModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="editExpenseModalLabel">S·ª≠a kho·∫£n chi ti√™u</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="edit-expense-form" class="row g-3">
            <input type="hidden" id="edit-expense-id">
            <div class="col-md-12 mb-3">
              <label class="form-label">S·ªë ti·ªÅn</label>
              <div class="input-group">
                <span class="input-group-text"><i class="bi bi-currency-dollar"></i></span>
                <input type="number" id="edit-amount" class="form-control" required>
              </div>
            </div>
            <div class="col-md-12 mb-3">
              <label class="form-label">M√¥ t·∫£</label>
              <input type="text" id="edit-description" class="form-control" required>
            </div>
            <div class="col-md-12 mb-3">
              <label class="form-label">Ng√†y</label>
              <input type="date" id="edit-date" class="form-control" required>
            </div>
            <div class="col-md-12 mb-3">
              <label class="form-label">Danh m·ª•c</label>
              <select id="edit-categoryId" class="form-select">
                <option value="">-- Ch·ªçn danh m·ª•c --</option>
                <!-- Categories will be loaded here -->
              </select>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">H·ªßy</button>
          <button type="button" id="save-edit-expense" class="btn btn-primary">L∆∞u thay ƒë·ªïi</button>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Delete Confirmation Modal -->
  <div class="modal fade" id="deleteConfirmModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-sm">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">X√°c nh·∫≠n x√≥a</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <p>B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a kho·∫£n chi ti√™u n√†y?</p>
          <input type="hidden" id="delete-expense-id">
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">H·ªßy</button>
          <button type="button" id="confirm-delete" class="btn btn-danger">X√≥a</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Add/Edit Category Modal -->
  <div class="modal fade" id="categoryModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="categoryModalLabel">Th√™m danh m·ª•c</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="category-form" class="row g-3">
            <input type="hidden" id="category-id">
            <div class="col-md-12 mb-3">
              <label class="form-label">T√™n danh m·ª•c</label>
              <input type="text" id="category-name" class="form-control" required minlength="2">
              <div class="invalid-feedback">T√™n danh m·ª•c ph·∫£i c√≥ √≠t nh·∫•t 2 k√Ω t·ª±</div>
            </div>
            <div class="col-md-6 mb-3">
              <label class="form-label">M√†u s·∫Øc</label>
              <input type="color" id="category-color" class="form-control form-control-color w-100" value="#72d1a8">
            </div>
            <div class="col-md-6 mb-3">
              <label class="form-label">Bi·ªÉu t∆∞·ª£ng</label>
              <select id="category-icon" class="form-select">
                <option value="bi-tag">‚ö™ Tag</option>
                <option value="bi-cup-hot">‚òï ƒê·ªì u·ªëng</option>
                <option value="bi-cart">üõí Mua s·∫Øm</option>
                <option value="bi-car-front">üöó Ph∆∞∆°ng ti·ªán</option>
                <option value="bi-house">üè† Nh√† c·ª≠a</option>
                <option value="bi-receipt">üìù H√≥a ƒë∆°n</option>
                <option value="bi-controller">üéÆ Gi·∫£i tr√≠</option>
                <option value="bi-hospital">üè• Y t·∫ø</option>
                <option value="bi-book">üìö Gi√°o d·ª•c</option>
                <option value="bi-cash">üí∞ Ti·ªÅn m·∫∑t</option>
                <option value="bi-gift">üéÅ Qu√† t·∫∑ng</option>
                <option value="bi-three-dots">‚ãØ Kh√°c</option>
              </select>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">H·ªßy</button>
          <button type="button" id="save-category" class="btn btn-primary">L∆∞u</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Delete Category Confirmation Modal -->
  <div class="modal fade" id="deleteCategoryModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-sm">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">X√°c nh·∫≠n x√≥a danh m·ª•c</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <p>B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a danh m·ª•c n√†y?</p>
          <p><small class="text-muted">C√°c chi ti√™u thu·ªôc danh m·ª•c n√†y s·∫Ω kh√¥ng b·ªã x√≥a.</small></p>
          <input type="hidden" id="delete-category-id">
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">H·ªßy</button>
          <button type="button" id="confirm-delete-category" class="btn btn-danger">X√≥a</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Add/Edit Budget Modal -->
  <div class="modal fade" id="budgetModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="budgetModalLabel">Th√™m ng√¢n s√°ch</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="budget-form" class="row g-3">
            <input type="hidden" id="budget-id">
            <div class="col-md-6 mb-3">
              <label class="form-label">S·ªë ti·ªÅn ng√¢n s√°ch</label>
              <div class="input-group">
                <span class="input-group-text"><i class="bi bi-currency-dollar"></i></span>
                <input type="number" id="budget-amount" class="form-control" required min="1">
              </div>
              <div class="invalid-feedback">S·ªë ti·ªÅn ng√¢n s√°ch kh√¥ng h·ª£p l·ªá</div>
            </div>
            <div class="col-md-6 mb-3">
              <label class="form-label">Chu k·ª≥</label>
              <select id="budget-period" class="form-select" required>
                <option value="week">H√†ng tu·∫ßn</option>
                <option value="month" selected>H√†ng th√°ng</option>
                <option value="year">H√†ng nƒÉm</option>
              </select>
            </div>
            <div class="col-md-12 mb-3">
              <label class="form-label">Danh m·ª•c</label>
              <select id="budget-categoryId" class="form-select" required>
                <option value="">-- Ch·ªçn danh m·ª•c --</option>
                <!-- Categories will be loaded here -->
              </select>
              <div class="invalid-feedback">Vui l√≤ng ch·ªçn danh m·ª•c</div>
            </div>
            <div class="col-md-6 mb-3">
              <label class="form-label">Ng√†y b·∫Øt ƒë·∫ßu</label>
              <input type="date" id="budget-startDate" class="form-control" required>
            </div>
            <div class="col-md-6 mb-3">
              <label class="form-label">Ng√†y k·∫øt th√∫c (t√πy ch·ªçn)</label>
              <input type="date" id="budget-endDate" class="form-control">
            </div>
            <div class="col-md-12 mb-3">
              <div class="form-check">
                <input class="form-check-input" type="checkbox" id="budget-isRecurring" checked>
                <label class="form-check-label" for="budget-isRecurring">
                  L·∫∑p l·∫°i h√†ng chu k·ª≥
                </label>
                <small class="form-text text-muted d-block">N·∫øu b·∫°n ch·ªçn t√πy ch·ªçn n√†y, ng√¢n s√°ch s·∫Ω t·ª± ƒë·ªông l·∫∑p l·∫°i h√†ng chu k·ª≥</small>
              </div>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">H·ªßy</button>
          <button type="button" id="save-budget" class="btn btn-primary">L∆∞u</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Delete Budget Confirmation Modal -->
  <div class="modal fade" id="deleteBudgetModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-sm">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">X√°c nh·∫≠n x√≥a ng√¢n s√°ch</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <p>B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a ng√¢n s√°ch n√†y?</p>
          <input type="hidden" id="delete-budget-id">
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">H·ªßy</button>
          <button type="button" id="confirm-delete-budget" class="btn btn-danger">X√≥a</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Add/Edit Income Modal -->
  <div class="modal fade" id="incomeModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="incomeModalLabel">Thu nh·∫≠p</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="income-form" class="row g-3">
            <input type="hidden" id="income-id">
            <div class="col-md-6 mb-3">
              <label class="form-label">S·ªë ti·ªÅn thu nh·∫≠p</label>
              <div class="input-group">
                <span class="input-group-text"><i class="bi bi-currency-dollar"></i></span>
                <input type="number" id="income-amount" class="form-control" required min="1">
              </div>
              <div class="invalid-feedback">S·ªë ti·ªÅn thu nh·∫≠p kh√¥ng h·ª£p l·ªá</div>
            </div>
            <div class="col-md-6 mb-3">
              <label class="form-label">Ngu·ªìn thu nh·∫≠p</label>
              <select id="income-source" class="form-select" required>
                <option value="">-- Ch·ªçn ngu·ªìn thu --</option>
                <option value="salary">L∆∞∆°ng</option>
                <option value="bonus">Th∆∞·ªüng</option>
                <option value="investment">ƒê·∫ßu t∆∞</option>
                <option value="freelance">Freelance</option>
                <option value="gift">Qu√† t·∫∑ng</option>
                <option value="other">Kh√°c</option>
              </select>
              <div class="invalid-feedback">Vui l√≤ng ch·ªçn ngu·ªìn thu</div>
            </div>
            <div class="col-md-12 mb-3">
              <label class="form-label">M√¥ t·∫£</label>
              <input type="text" id="income-description" class="form-control" required>
              <div class="invalid-feedback">M√¥ t·∫£ kh√¥ng ƒë∆∞·ª£c ƒë·ªÉ tr·ªëng</div>
            </div>
            <div class="col-md-6 mb-3">
              <label class="form-label">Ng√†y</label>
              <input type="date" id="income-date" class="form-control" required>
              <div class="invalid-feedback">Ng√†y kh√¥ng h·ª£p l·ªá</div>
            </div>
            <div class="col-md-6 mb-3">
              <div class="form-check mt-4">
                <input class="form-check-input" type="checkbox" id="income-isRecurring">
                <label class="form-check-label" for="income-isRecurring">
                  Thu nh·∫≠p l·∫∑p l·∫°i
                </label>
              </div>
            </div>
            <div class="col-md-12 mb-3" id="frequency-group" style="display: none;">
              <label class="form-label">T·∫ßn su·∫•t</label>
              <select id="income-frequency" class="form-select">
                <option value="weekly">H√†ng tu·∫ßn</option>
                <option value="monthly" selected>H√†ng th√°ng</option>
                <option value="yearly">H√†ng nƒÉm</option>
              </select>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">H·ªßy</button>
          <button type="button" id="save-income" class="btn btn-primary">L∆∞u</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Delete Income Confirmation Modal -->
  <div class="modal fade" id="deleteIncomeModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-sm">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">X√°c nh·∫≠n x√≥a thu nh·∫≠p</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <p>B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a thu nh·∫≠p n√†y?</p>
          <input type="hidden" id="delete-income-id">
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">H·ªßy</button>
          <button type="button" id="confirm-delete-income" class="btn btn-danger">X√≥a</button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // Token check
    if (!localStorage.getItem('token')) {
      window.location.href = '/login';
    }

    function getToken() {
      return localStorage.getItem('token');
    }

    // Format currency
    function formatCurrency(amount) {
      return new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(amount);
    }

    // Format date
    function formatDate(dateString) {
      const date = new Date(dateString);
      return date.toLocaleDateString('vi-VN');
    }

    // Fetch expenses
    function fetchExpenses() {
      fetch('/api/expenses', {
        headers: {
          'Authorization': 'Bearer ' + getToken()
        }
      })
        .then(res => {
          if(res.status === 401) {
            localStorage.removeItem('token');
            window.location.href = '/login';
            return;
          }
          return res.json();
        })
        .then(data => {
          const list = document.getElementById('expense-list');
          const totalAmountElement = document.getElementById('total-amount');
          let total = 0;
          
          if (!data || data.length === 0) {
            list.innerHTML = '<tr><td colspan="5" class="text-center text-muted py-4">Ch∆∞a c√≥ chi ti√™u n√†o</td></tr>';
            totalAmountElement.innerText = '0ƒë';
            return;
          }
          
          list.innerHTML = '';
          data.forEach(item => {
            total += item.amount;
            const tr = document.createElement('tr');
            
            // Category display
            const categoryDisplay = item.category 
              ? `<span class="badge rounded-pill" style="background-color: ${item.category.color}">
                  <i class="bi ${item.category.icon} me-1"></i>
                  ${item.category.name}
                 </span>` 
              : '<span class="badge bg-secondary">Ch∆∞a ph√¢n lo·∫°i</span>';
            
            tr.innerHTML = `
              <td class="ps-4">${item.description}</td>
              <td>${categoryDisplay}</td>
              <td>${formatDate(item.date)}</td>
              <td class="text-end amount">${formatCurrency(item.amount)}</td>
              <td class="text-center">
                <button class="btn btn-icon btn-light me-1 edit-expense" data-id="${item.id}" title="S·ª≠a">
                  <i class="bi bi-pencil-square"></i>
                </button>
                <button class="btn btn-icon btn-light delete-expense" data-id="${item.id}" title="X√≥a">
                  <i class="bi bi-trash text-danger"></i>
                </button>
              </td>
            `;
            list.appendChild(tr);
          });
          
          totalAmountElement.innerText = formatCurrency(total);
          
          // G√°n s·ª± ki·ªán cho n√∫t s·ª≠a v√† x√≥a
          setupEditButtons();
          setupDeleteButtons();
        })
        .catch(err => {
          console.error('L·ªói khi l·∫•y d·ªØ li·ªáu:', err);
        });
    }
    
    // G√°n s·ª± ki·ªán cho n√∫t s·ª≠a
    function setupEditButtons() {
      document.querySelectorAll('.edit-expense').forEach(button => {
        button.addEventListener('click', function() {
          const expenseId = this.getAttribute('data-id');
          
          // L·∫•y th√¥ng tin t·ª´ h√†ng
          const row = this.closest('tr');
          const description = row.cells[0].innerText;
          const category = row.cells[1].innerText;
          const dateString = row.cells[2].innerText;
          const amount = row.cells[3].innerText.replace(/\D/g, '');
          
          // Chuy·ªÉn ƒë·ªïi ng√†y sang ƒë·ªãnh d·∫°ng YYYY-MM-DD cho input date
          const dateParts = dateString.split('/');
          const formattedDate = `${dateParts[2]}-${dateParts[1].padStart(2, '0')}-${dateParts[0].padStart(2, '0')}`;
          
          // ƒêi·ªÅn d·ªØ li·ªáu v√†o form
          document.getElementById('edit-expense-id').value = expenseId;
          document.getElementById('edit-amount').value = amount;
          document.getElementById('edit-description').value = description;
          document.getElementById('edit-date').value = formattedDate;
          document.getElementById('edit-categoryId').value = category;
          
          // M·ªü modal
          const modal = new bootstrap.Modal(document.getElementById('editExpenseModal'));
          modal.show();
        });
      });
    }
    
    // G√°n s·ª± ki·ªán cho n√∫t x√≥a
    function setupDeleteButtons() {
      document.querySelectorAll('.delete-expense').forEach(button => {
        button.addEventListener('click', function() {
          const expenseId = this.getAttribute('data-id');
          document.getElementById('delete-expense-id').value = expenseId;
          
          // M·ªü modal x√°c nh·∫≠n
          const modal = new bootstrap.Modal(document.getElementById('deleteConfirmModal'));
          modal.show();
        });
      });
    }

    // X·ª≠ l√Ω l∆∞u thay ƒë·ªïi
    document.getElementById('save-edit-expense').addEventListener('click', function() {
      const id = document.getElementById('edit-expense-id').value;
      const amount = document.getElementById('edit-amount').value;
      const description = document.getElementById('edit-description').value;
      const date = document.getElementById('edit-date').value;
      const categoryId = document.getElementById('edit-categoryId').value;
      
      if (!amount || !description || !date) {
        alert('Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin!');
        return;
      }
      
      // G·ª≠i API c·∫≠p nh·∫≠t
      fetch(`/api/expenses/${id}`, {
        method: 'PUT',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': 'Bearer ' + getToken()
        },
        body: JSON.stringify({ amount, description, date, categoryId: categoryId || null })
      })
      .then(res => {
        if(res.status === 401) {
          localStorage.removeItem('token');
          window.location.href = '/login';
          return;
        }
        return res.json();
      })
      .then(data => {
        if(data.success) {
          // ƒê√≥ng modal
          bootstrap.Modal.getInstance(document.getElementById('editExpenseModal')).hide();
          
          // C·∫≠p nh·∫≠t l·∫°i danh s√°ch
          fetchExpenses();
        } else {
          alert(data.error || 'C√≥ l·ªói x·∫£y ra!');
        }
      })
      .catch(err => {
        console.error('L·ªói khi c·∫≠p nh·∫≠t:', err);
        alert('L·ªói k·∫øt n·ªëi server!');
      });
    });
    
    // X·ª≠ l√Ω x√≥a
    document.getElementById('confirm-delete').addEventListener('click', function() {
      const id = document.getElementById('delete-expense-id').value;
      
      // G·ª≠i API x√≥a
      fetch(`/api/expenses/${id}`, {
        method: 'DELETE',
        headers: {
          'Authorization': 'Bearer ' + getToken()
        }
      })
      .then(res => {
        if(res.status === 401) {
          localStorage.removeItem('token');
          window.location.href = '/login';
          return;
        }
        return res.json();
      })
      .then(data => {
        if(data.success) {
          // ƒê√≥ng modal
          bootstrap.Modal.getInstance(document.getElementById('deleteConfirmModal')).hide();
          
          // C·∫≠p nh·∫≠t l·∫°i danh s√°ch
          fetchExpenses();
        } else {
          alert(data.error || 'C√≥ l·ªói x·∫£y ra!');
        }
      })
      .catch(err => {
        console.error('L·ªói khi x√≥a:', err);
        alert('L·ªói k·∫øt n·ªëi server!');
      });
    });

    // Th√™m m·ªõi chi ti√™u
    document.getElementById('expense-form').addEventListener('submit', function(e) {
      e.preventDefault();
      
      const amount = document.getElementById('amount').value;
      const description = document.getElementById('description').value;
      const date = document.getElementById('date').value;
      const categoryId = document.getElementById('categoryId').value;

      fetch('/api/expenses', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': 'Bearer ' + getToken()
        },
        body: JSON.stringify({ 
          amount, 
          description, 
          date, 
          categoryId: categoryId || null 
        })
      })
        .then(res => {
          if(res.status === 401) {
            localStorage.removeItem('token');
            window.location.href = '/login';
            return;
          }
          return res.json();
        })
        .then(data => {
          if(data.success) {
            // Reset form
            document.getElementById('amount').value = '';
            document.getElementById('description').value = '';
            document.getElementById('categoryId').value = '';
            fetchExpenses();
          } else {
            alert(data.error || 'C√≥ l·ªói x·∫£y ra khi th√™m chi ti√™u!');
          }
        })
        .catch(err => {
          console.error('L·ªói khi th√™m chi ti√™u:', err);
          alert('L·ªói k·∫øt n·ªëi server!');
        });
    });
    
    // ƒêƒÉng xu·∫•t
    document.getElementById('logout-btn').addEventListener('click', function() {
      localStorage.removeItem('token');
      window.location.href = '/login';
    });

    // =================== Category Management ===================
    // Load danh s√°ch danh m·ª•c
    function fetchCategories() {
      fetch('/api/categories', {
        headers: {
          'Authorization': 'Bearer ' + getToken()
        }
      })
      .then(res => {
        if(res.status === 401) {
          localStorage.removeItem('token');
          window.location.href = '/login';
          return;
        }
        return res.json();
      })
      .then(data => {
        if (!data || data.length === 0) {
          document.getElementById('category-list').innerHTML = '<li class="list-group-item text-center text-muted py-3">Ch∆∞a c√≥ danh m·ª•c n√†o</li>';
          return;
        }

        // Render danh s√°ch danh m·ª•c
        const list = document.getElementById('category-list');
        list.innerHTML = '';
        
        data.forEach(category => {
          const li = document.createElement('li');
          li.className = 'list-group-item d-flex justify-content-between align-items-center';
          li.innerHTML = `
            <div class="d-flex align-items-center">
              <span class="category-icon me-2" style="color: ${category.color}">
                <i class="bi ${category.icon}"></i>
              </span>
              <span>${category.name}</span>
            </div>
            <div>
              <button class="btn btn-icon btn-light me-1 edit-category" data-id="${category.id}" title="S·ª≠a">
                <i class="bi bi-pencil-square" style="color: ${category.color}"></i>
              </button>
              <button class="btn btn-icon btn-light delete-category" data-id="${category.id}" title="X√≥a">
                <i class="bi bi-trash text-danger"></i>
              </button>
            </div>
          `;
          list.appendChild(li);
        });

        // C·∫≠p nh·∫≠t c√°c dropdown select trong form th√™m/s·ª≠a chi ti√™u
        updateCategoryDropdowns(data);
        
        // G√°n s·ª± ki·ªán cho c√°c n√∫t s·ª≠a/x√≥a danh m·ª•c
        setupCategoryButtons();
      })
      .catch(err => {
        console.error('L·ªói khi l·∫•y danh m·ª•c:', err);
      });
    }

    // C·∫≠p nh·∫≠t c√°c dropdown select trong form th√™m/s·ª≠a chi ti√™u
    function updateCategoryDropdowns(categories) {
      const dropdowns = ['categoryId', 'edit-categoryId'];
      
      dropdowns.forEach(id => {
        const dropdown = document.getElementById(id);
        if (dropdown) {
          // Gi·ªØ l·∫°i option m·∫∑c ƒë·ªãnh
          const defaultOption = dropdown.querySelector('option[value=""]');
          dropdown.innerHTML = '';
          dropdown.appendChild(defaultOption);
          
          // Th√™m c√°c option danh m·ª•c
          categories.forEach(category => {
            const option = document.createElement('option');
            option.value = category.id;
            option.textContent = `${category.name}`;
            option.setAttribute('data-color', category.color);
            option.setAttribute('data-icon', category.icon);
            dropdown.appendChild(option);
          });
        }
      });
    }

    // G√°n s·ª± ki·ªán cho c√°c n√∫t qu·∫£n l√Ω danh m·ª•c
    function setupCategoryButtons() {
      // S·ª± ki·ªán cho n√∫t s·ª≠a danh m·ª•c
      document.querySelectorAll('.edit-category').forEach(btn => {
        btn.addEventListener('click', function() {
          const categoryId = this.getAttribute('data-id');
          
          // L·∫•y th√¥ng tin t·ª´ h√†ng
          const row = this.closest('li');
          const name = row.cells[0].innerText;
          const color = row.querySelector('.category-icon').style.color;
          const icon = row.querySelector('.category-icon i').className;
          
          // ƒêi·ªÅn th√¥ng tin v√†o form
          document.getElementById('category-id').value = categoryId;
          document.getElementById('category-name').value = name;
          document.getElementById('category-color').value = color;
          document.getElementById('category-icon').value = icon;
          
          // M·ªü modal
          const modal = new bootstrap.Modal(document.getElementById('categoryModal'));
          modal.show();
        });
      });
      
      // S·ª± ki·ªán cho n√∫t x√≥a danh m·ª•c
      document.querySelectorAll('.delete-category').forEach(btn => {
        btn.addEventListener('click', function() {
          const categoryId = this.getAttribute('data-id');
          document.getElementById('delete-category-id').value = categoryId;
          const modal = new bootstrap.Modal(document.getElementById('deleteCategoryModal'));
          modal.show();
        });
      });
    }

    // L·∫•y chi ti·∫øt danh m·ª•c theo ID
    function fetchCategoryDetails(categoryId) {
      fetch(`/api/categories/${categoryId}`, {
        headers: {
          'Authorization': 'Bearer ' + getToken()
        }
      })
      .then(res => {
        if(res.status === 401) {
          localStorage.removeItem('token');
          window.location.href = '/login';
          return;
        }
        return res.json();
      })
      .then(category => {
        if (category) {
          // ƒêi·ªÅn th√¥ng tin danh m·ª•c v√†o form
          document.getElementById('category-id').value = category.id;
          document.getElementById('category-name').value = category.name;
          document.getElementById('category-color').value = category.color;
          document.getElementById('category-icon').value = category.icon;
          
          // ƒê·ªïi ti√™u ƒë·ªÅ modal
          document.getElementById('categoryModalLabel').textContent = 'S·ª≠a danh m·ª•c';
          
          // Hi·ªÉn th·ªã modal
          const modal = new bootstrap.Modal(document.getElementById('categoryModal'));
          modal.show();
        }
      })
      .catch(err => {
        console.error('L·ªói khi l·∫•y chi ti·∫øt danh m·ª•c:', err);
      });
    }

    // S·ª± ki·ªán cho n√∫t th√™m danh m·ª•c m·ªõi
    document.getElementById('add-category-btn').addEventListener('click', function() {
      // Reset form
      document.getElementById('category-id').value = '';
      document.getElementById('category-name').value = '';
      document.getElementById('category-color').value = '#72d1a8';
      document.getElementById('category-icon').value = 'bi-tag';
      
      // ƒê·ªïi ti√™u ƒë·ªÅ modal
      document.getElementById('categoryModalLabel').textContent = 'Th√™m danh m·ª•c';
      
      // Hi·ªÉn th·ªã modal
      const modal = new bootstrap.Modal(document.getElementById('categoryModal'));
      modal.show();
    });

    // S·ª± ki·ªán l∆∞u danh m·ª•c (th√™m/s·ª≠a)
    document.getElementById('save-category').addEventListener('click', function() {
      const categoryId = document.getElementById('category-id').value;
      const name = document.getElementById('category-name').value;
      const color = document.getElementById('category-color').value;
      const icon = document.getElementById('category-icon').value;
      
      if (!name) {
        document.getElementById('category-name').classList.add('is-invalid');
        return;
      }
      
      const method = categoryId ? 'PUT' : 'POST';
      const url = categoryId ? `/api/categories/${categoryId}` : '/api/categories';
      
      fetch(url, {
        method: method,
        headers: {
          'Content-Type': 'application/json',
          'Authorization': 'Bearer ' + getToken()
        },
        body: JSON.stringify({ name, color, icon })
      })
      .then(res => {
        if(res.status === 401) {
          localStorage.removeItem('token');
          window.location.href = '/login';
          return;
        }
        return res.json();
      })
      .then(data => {
        if(data.success) {
          // ƒê√≥ng modal
          bootstrap.Modal.getInstance(document.getElementById('categoryModal')).hide();
          
          // C·∫≠p nh·∫≠t l·∫°i danh s√°ch danh m·ª•c
          fetchCategories();
        } else if (data.errors) {
          // Hi·ªÉn th·ªã l·ªói validation
          const errors = data.errors;
          if (errors.name) {
            document.getElementById('category-name').classList.add('is-invalid');
            document.getElementById('category-name').nextElementSibling.textContent = errors.name;
          }
        } else {
          alert(data.error || 'C√≥ l·ªói x·∫£y ra!');
        }
      })
      .catch(err => {
        console.error('L·ªói khi l∆∞u danh m·ª•c:', err);
        alert('L·ªói k·∫øt n·ªëi server!');
      });
    });

    // S·ª± ki·ªán x√≥a danh m·ª•c
    document.getElementById('confirm-delete-category').addEventListener('click', function() {
      const categoryId = document.getElementById('delete-category-id').value;
      
      fetch(`/api/categories/${categoryId}`, {
        method: 'DELETE',
        headers: {
          'Authorization': 'Bearer ' + getToken()
        }
      })
      .then(res => {
        if(res.status === 401) {
          localStorage.removeItem('token');
          window.location.href = '/login';
          return;
        }
        return res.json();
      })
      .then(data => {
        if(data.success) {
          // ƒê√≥ng modal
          bootstrap.Modal.getInstance(document.getElementById('deleteCategoryModal')).hide();
          
          // C·∫≠p nh·∫≠t l·∫°i danh s√°ch danh m·ª•c
          fetchCategories();
        } else {
          alert(data.error || 'C√≥ l·ªói x·∫£y ra!');
        }
      })
      .catch(err => {
        console.error('L·ªói khi x√≥a danh m·ª•c:', err);
        alert('L·ªói k·∫øt n·ªëi server!');
      });
    });

    // S·ª± ki·ªán t·∫°o danh m·ª•c m·∫∑c ƒë·ªãnh
    document.getElementById('add-default-categories').addEventListener('click', function() {
      if (!confirm('B·∫°n c√≥ mu·ªën t·∫°o c√°c danh m·ª•c m·∫∑c ƒë·ªãnh kh√¥ng?')) {
        return;
      }
      
      fetch('/api/categories/default', {
        method: 'POST',
        headers: {
          'Authorization': 'Bearer ' + getToken()
        }
      })
      .then(res => {
        if(res.status === 401) {
          localStorage.removeItem('token');
          window.location.href = '/login';
          return;
        }
        return res.json();
      })
      .then(data => {
        if(data.success) {
          // C·∫≠p nh·∫≠t l·∫°i danh s√°ch danh m·ª•c
          fetchCategories();
        } else {
          alert(data.error || 'C√≥ l·ªói x·∫£y ra!');
        }
      })
      .catch(err => {
        console.error('L·ªói khi t·∫°o danh m·ª•c m·∫∑c ƒë·ªãnh:', err);
        alert('L·ªói k·∫øt n·ªëi server!');
      });
    });

    // =================== Expense Management ===================
    // Update fetch expenses to support categories
    function fetchExpenses() {
      fetch('/api/expenses', {
        headers: {
          'Authorization': 'Bearer ' + getToken()
        }
      })
      .then(res => {
        if(res.status === 401) {
          localStorage.removeItem('token');
          window.location.href = '/login';
          return;
        }
        return res.json();
      })
      .then(data => {
        const list = document.getElementById('expense-list');
        const totalAmountElement = document.getElementById('total-amount');
        let total = 0;
        
        if (!data || data.length === 0) {
          list.innerHTML = '<tr><td colspan="5" class="text-center text-muted py-4">Ch∆∞a c√≥ chi ti√™u n√†o</td></tr>';
          totalAmountElement.innerText = '0ƒë';
          return;
        }
        
        list.innerHTML = '';
        data.forEach(item => {
          total += item.amount;
          const tr = document.createElement('tr');
          
          // Category display
          const categoryDisplay = item.category 
            ? `<span class="badge rounded-pill" style="background-color: ${item.category.color}">
                <i class="bi ${item.category.icon} me-1"></i>
                ${item.category.name}
               </span>` 
            : '<span class="badge bg-secondary">Ch∆∞a ph√¢n lo·∫°i</span>';
          
          tr.innerHTML = `
            <td class="ps-4">${item.description}</td>
            <td>${categoryDisplay}</td>
            <td>${formatDate(item.date)}</td>
            <td class="text-end amount">${formatCurrency(item.amount)}</td>
            <td class="text-center">
              <button class="btn btn-icon btn-light me-1 edit-expense" data-id="${item.id}" title="S·ª≠a">
                <i class="bi bi-pencil-square"></i>
              </button>
              <button class="btn btn-icon btn-light delete-expense" data-id="${item.id}" title="X√≥a">
                <i class="bi bi-trash text-danger"></i>
              </button>
            </td>
          `;
          list.appendChild(tr);
        });
        
        totalAmountElement.innerText = formatCurrency(total);
        
        // G√°n s·ª± ki·ªán cho n√∫t s·ª≠a v√† x√≥a
        setupEditButtons();
        setupDeleteButtons();
      })
      .catch(err => {
        console.error('L·ªói khi l·∫•y d·ªØ li·ªáu:', err);
      });
    }
    
    // Modify setupEditButtons to support categories
    function setupEditButtons() {
      document.querySelectorAll('.edit-expense').forEach(button => {
        button.addEventListener('click', function() {
          const expenseId = this.getAttribute('data-id');
          
          // L·∫•y th√¥ng tin t·ª´ h√†ng
          const row = this.closest('tr');
          const description = row.cells[0].innerText;
          const category = row.cells[1].innerText;
          const dateString = row.cells[2].innerText;
          const amount = row.cells[3].innerText.replace(/\D/g, '');
          
          // Chuy·ªÉn ƒë·ªïi ng√†y sang ƒë·ªãnh d·∫°ng YYYY-MM-DD cho input date
          const dateParts = dateString.split('/');
          const formattedDate = `${dateParts[2]}-${dateParts[1].padStart(2, '0')}-${dateParts[0].padStart(2, '0')}`;
          
          // ƒêi·ªÅn d·ªØ li·ªáu v√†o form
          document.getElementById('edit-expense-id').value = expenseId;
          document.getElementById('edit-amount').value = amount;
          document.getElementById('edit-description').value = description;
          document.getElementById('edit-date').value = formattedDate;
          document.getElementById('edit-categoryId').value = category;
          
          // M·ªü modal
          const modal = new bootstrap.Modal(document.getElementById('editExpenseModal'));
          modal.show();
        });
      });
    }
    
    // Update expense form save handler
    document.getElementById('save-edit-expense').addEventListener('click', function() {
      const id = document.getElementById('edit-expense-id').value;
      const amount = document.getElementById('edit-amount').value;
      const description = document.getElementById('edit-description').value;
      const date = document.getElementById('edit-date').value;
      const categoryId = document.getElementById('edit-categoryId').value;
      
      if (!amount || !description || !date) {
        alert('Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin!');
        return;
      }
      
      fetch(`/api/expenses/${id}`, {
        method: 'PUT',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': 'Bearer ' + getToken()
        },
        body: JSON.stringify({ amount, description, date, categoryId: categoryId || null })
      })
      .then(res => {
        if(res.status === 401) {
          localStorage.removeItem('token');
          window.location.href = '/login';
          return;
        }
        return res.json();
      })
      .then(data => {
        if(data.success) {
          // ƒê√≥ng modal
          bootstrap.Modal.getInstance(document.getElementById('editExpenseModal')).hide();
          
          // C·∫≠p nh·∫≠t l·∫°i danh s√°ch
          fetchExpenses();
        } else {
          alert(data.error || 'C√≥ l·ªói x·∫£y ra!');
        }
      })
      .catch(err => {
        console.error('L·ªói khi c·∫≠p nh·∫≠t:', err);
        alert('L·ªói k·∫øt n·ªëi server!');
      });
    });
    
    // Update add expense form submit handler
    document.getElementById('expense-form').addEventListener('submit', function(e) {
      e.preventDefault();
      
      const amount = document.getElementById('amount').value;
      const description = document.getElementById('description').value;
      const date = document.getElementById('date').value;
      const categoryId = document.getElementById('categoryId').value;

      fetch('/api/expenses', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': 'Bearer ' + getToken()
        },
        body: JSON.stringify({ 
          amount, 
          description, 
          date, 
          categoryId: categoryId || null 
        })
      })
        .then(res => {
          if(res.status === 401) {
            localStorage.removeItem('token');
            window.location.href = '/login';
            return;
          }
          return res.json();
        })
        .then(data => {
          if(data.success) {
            // Reset form
            document.getElementById('amount').value = '';
            document.getElementById('description').value = '';
            document.getElementById('categoryId').value = '';
            fetchExpenses();
          } else {
            alert(data.error || 'C√≥ l·ªói x·∫£y ra khi th√™m chi ti√™u!');
          }
        })
        .catch(err => {
          console.error('L·ªói khi th√™m chi ti√™u:', err);
          alert('L·ªói k·∫øt n·ªëi server!');
        });
    });

    // =================== Budget Management ===================
    // Load budgets
    function loadBudgets() {
      fetch('/api/budgets', {
        headers: {
          'Authorization': 'Bearer ' + getToken()
        }
      })
      .then(res => {
        if(res.status === 401) {
          localStorage.removeItem('token');
          window.location.href = '/login';
          return;
        }
        return res.json();
      })
      .then(data => {
        const list = document.getElementById('budget-list');
        
        if (!data || data.length === 0) {
          list.innerHTML = '<div class="budget-item text-center text-muted py-3">Ch∆∞a c√≥ ng√¢n s√°ch n√†o</div>';
          return;
        }
        
        list.innerHTML = '';
        
        data.forEach(budget => {
          const div = document.createElement('div');
          div.className = 'budget-item';
          div.innerHTML = `
            <div class="budget-category" style="color: ${budget.category.color}">
              <i class="bi ${budget.category.icon}"></i>
              <span>${budget.category.name}</span>
            </div>
            <div class="d-flex justify-content-between align-items-center">
              <div class="budget-title">${budget.period}</div>
              <div class="budget-amount">${formatCurrency(budget.amount)}</div>
            </div>
            <div class="budget-actions">
              <button class="btn btn-sm btn-outline-secondary me-1 edit-budget" data-id="${budget.id}">
                <i class="bi bi-pencil"></i> S·ª≠a
              </button>
              <button class="btn btn-sm btn-outline-danger delete-budget" data-id="${budget.id}">
                <i class="bi bi-trash"></i> X√≥a
              </button>
            </div>
          `;
          list.appendChild(div);
        });
        
        // G√°n s·ª± ki·ªán cho n√∫t s·ª≠a v√† x√≥a ng√¢n s√°ch
        setupBudgetButtons();
      })
      .catch(err => {
        console.error('L·ªói khi t·∫£i ng√¢n s√°ch:', err);
      });
    }
    
    // G√°n s·ª± ki·ªán cho n√∫t s·ª≠a v√† x√≥a ng√¢n s√°ch
    function setupBudgetButtons() {
      document.querySelectorAll('.edit-budget').forEach(button => {
        button.addEventListener('click', function() {
          const budgetId = this.getAttribute('data-id');
          fetchBudgetDetails(budgetId);
        });
      });
      
      document.querySelectorAll('.delete-budget').forEach(button => {
        button.addEventListener('click', function() {
          const budgetId = this.getAttribute('data-id');
          document.getElementById('delete-budget-id').value = budgetId;
          const modal = new bootstrap.Modal(document.getElementById('deleteBudgetModal'));
          modal.show();
        });
      });
    }
    
    // Load budget details
    function fetchBudgetDetails(budgetId) {
      fetch(`/api/budgets/${budgetId}`, {
        headers: {
          'Authorization': 'Bearer ' + getToken()
        }
      })
      .then(res => {
        if(res.status === 401) {
          localStorage.removeItem('token');
          window.location.href = '/login';
          return;
        }
        return res.json();
      })
      .then(budget => {
        if (budget) {
          // ƒêi·ªÅn d·ªØ li·ªáu v√†o form
          document.getElementById('budget-id').value = budget.id;
          document.getElementById('budget-amount').value = budget.amount;
          document.getElementById('budget-period').value = budget.period;
          document.getElementById('budget-categoryId').value = budget.categoryId;
          document.getElementById('budget-startDate').value = new Date(budget.startDate).toISOString().split('T')[0];
          document.getElementById('budget-endDate').value = budget.endDate ? new Date(budget.endDate).toISOString().split('T')[0] : '';
          document.getElementById('budget-isRecurring').checked = budget.isRecurring;
          
          // M·ªü modal
          const modal = new bootstrap.Modal(document.getElementById('budgetModal'));
          modal.show();
        }
      })
      .catch(err => {
        console.error('L·ªói khi t·∫£i ng√¢n s√°ch:', err);
      });
    }
    
    // Th√™m m·ªõi ng√¢n s√°ch
    document.getElementById('add-budget-btn').addEventListener('click', function() {
      // Reset form
      document.getElementById('budget-id').value = '';
      document.getElementById('budget-amount').value = '';
      document.getElementById('budget-period').value = 'month';
      document.getElementById('budget-categoryId').value = '';
      document.getElementById('budget-startDate').value = '';
      document.getElementById('budget-endDate').value = '';
      document.getElementById('budget-isRecurring').checked = true;
      
      // M·ªü modal
      const modal = new bootstrap.Modal(document.getElementById('budgetModal'));
      modal.show();
    });
    
    // L∆∞u ng√¢n s√°ch
    document.getElementById('save-budget').addEventListener('click', function() {
      const budgetId = document.getElementById('budget-id').value;
      const amount = document.getElementById('budget-amount').value;
      const period = document.getElementById('budget-period').value;
      const categoryId = document.getElementById('budget-categoryId').value;
      const startDate = document.getElementById('budget-startDate').value;
      const endDate = document.getElementById('budget-endDate').value;
      const isRecurring = document.getElementById('budget-isRecurring').checked;
      
      if (!amount || !startDate) {
        alert('Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin!');
        return;
      }
      
      const method = budgetId ? 'PUT' : 'POST';
      const url = budgetId ? `/api/budgets/${budgetId}` : '/api/budgets';
      
      fetch(url, {
        method: method,
        headers: {
          'Content-Type': 'application/json',
          'Authorization': 'Bearer ' + getToken()
        },
        body: JSON.stringify({
          amount,
          period,
          categoryId,
          startDate,
          endDate: endDate || null,
          isRecurring
        })
      })
      .then(res => {
        if(res.status === 401) {
          localStorage.removeItem('token');
          window.location.href = '/login';
          return;
        }
        return res.json();
      })
      .then(data => {
        if(data.success) {
          // ƒê√≥ng modal
          bootstrap.Modal.getInstance(document.getElementById('budgetModal')).hide();
          
          // C·∫≠p nh·∫≠t l·∫°i danh s√°ch ng√¢n s√°ch
          loadBudgets();
        } else {
          alert(data.error || 'C√≥ l·ªói x·∫£y ra!');
        }
      })
      .catch(err => {
        console.error('L·ªói khi l∆∞u ng√¢n s√°ch:', err);
        alert('L·ªói k·∫øt n·ªëi server!');
      });
    });
    
    // X√≥a ng√¢n s√°ch
    document.getElementById('confirm-delete-budget').addEventListener('click', function() {
      const budgetId = document.getElementById('delete-budget-id').value;
      
      fetch(`/api/budgets/${budgetId}`, {
        method: 'DELETE',
        headers: {
          'Authorization': 'Bearer ' + getToken()
        }
      })
      .then(res => {
        if(res.status === 401) {
          localStorage.removeItem('token');
          window.location.href = '/login';
          return;
        }
        return res.json();
      })
      .then(data => {
        if(data.success) {
          // ƒê√≥ng modal
          bootstrap.Modal.getInstance(document.getElementById('deleteBudgetModal')).hide();
          
          // C·∫≠p nh·∫≠t l·∫°i danh s√°ch ng√¢n s√°ch
          loadBudgets();
        } else {
          alert(data.error || 'C√≥ l·ªói x·∫£y ra!');
        }
      })
      .catch(err => {
        console.error('L·ªói khi x√≥a ng√¢n s√°ch:', err);
        alert('L·ªói k·∫øt n·ªëi server!');
      });
    });

    // Load incomes
    function loadIncomes() {
      fetch('/api/incomes', {
        headers: {
          'Authorization': `Bearer ${token}`
        }
      })
      .then(response => {
        if (!response.ok) throw new Error('Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu thu nh·∫≠p');
        return response.json();
      })
      .then(incomes => {
        const incomeList = document.getElementById('income-list');
        incomeList.innerHTML = '';
        
        if (incomes.length === 0) {
          incomeList.innerHTML = '<div class="p-3 text-center text-muted">Ch∆∞a c√≥ thu nh·∫≠p n√†o ƒë∆∞·ª£c th√™m</div>';
          return;
        }
        
        incomes.forEach(income => {
          // X√°c ƒë·ªãnh icon cho ngu·ªìn thu nh·∫≠p
          let sourceIcon = 'bi-cash';
          switch(income.source) {
            case 'salary': sourceIcon = 'bi-briefcase'; break;
            case 'bonus': sourceIcon = 'bi-gift'; break;
            case 'investment': sourceIcon = 'bi-graph-up-arrow'; break;
            case 'freelance': sourceIcon = 'bi-laptop'; break;
            case 'gift': sourceIcon = 'bi-box2-heart'; break;
            default: sourceIcon = 'bi-cash';
          }
          
          // X√°c ƒë·ªãnh t√™n ngu·ªìn thu nh·∫≠p
          let sourceName = 'Kh√°c';
          switch(income.source) {
            case 'salary': sourceName = 'L∆∞∆°ng'; break;
            case 'bonus': sourceName = 'Th∆∞·ªüng'; break;
            case 'investment': sourceName = 'ƒê·∫ßu t∆∞'; break;
            case 'freelance': sourceName = 'Freelance'; break;
            case 'gift': sourceName = 'Qu√† t·∫∑ng'; break;
            default: sourceName = 'Kh√°c';
          }
          
          const incomeItem = document.createElement('div');
          incomeItem.className = 'income-item';
          incomeItem.innerHTML = `
            <div class="d-flex justify-content-between align-items-start">
              <div>
                <div class="income-source">
                  <i class="bi ${sourceIcon}"></i> ${income.description}
                  ${income.isRecurring ? '<span class="income-recurring">L·∫∑p l·∫°i</span>' : ''}
                </div>
                <div class="income-amount">${formatCurrency(income.amount)}</div>
                <div class="income-date">
                  <i class="bi bi-calendar3"></i> ${formatDate(income.date)} ¬∑ ${sourceName}
                </div>
              </div>
              <div class="dropdown">
                <button class="btn btn-sm btn-light" type="button" data-bs-toggle="dropdown">
                  <i class="bi bi-three-dots-vertical"></i>
                </button>
                <ul class="dropdown-menu dropdown-menu-end">
                  <li><a class="dropdown-item edit-income" href="#" data-id="${income.id}">S·ª≠a</a></li>
                  <li><a class="dropdown-item delete-income" href="#" data-id="${income.id}">X√≥a</a></li>
                </ul>
              </div>
            </div>
          `;
          
          incomeList.appendChild(incomeItem);
        });
        
        // Th√™m event listeners cho c√°c n√∫t s·ª≠a v√† x√≥a
        document.querySelectorAll('.edit-income').forEach(button => {
          button.addEventListener('click', function(e) {
            e.preventDefault();
            const incomeId = this.getAttribute('data-id');
            editIncome(incomeId);
          });
        });
        
        document.querySelectorAll('.delete-income').forEach(button => {
          button.addEventListener('click', function(e) {
            e.preventDefault();
            const incomeId = this.getAttribute('data-id');
            document.getElementById('delete-income-id').value = incomeId;
            const deleteIncomeModal = new bootstrap.Modal(document.getElementById('deleteIncomeModal'));
            deleteIncomeModal.show();
          });
        });
      })
      .catch(error => {
        console.error('L·ªói khi t·∫£i thu nh·∫≠p:', error);
        showAlert('danger', 'Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu thu nh·∫≠p: ' + error.message);
      });
    }

    // Load balance summary
    function loadBalanceSummary() {
      fetch('/api/incomes/balance?period=month', {
        headers: {
          'Authorization': `Bearer ${token}`
        }
      })
      .then(response => {
        if (!response.ok) throw new Error('Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu c√¢n ƒë·ªëi thu chi');
        return response.json();
      })
      .then(balance => {
        const balanceSummary = document.getElementById('balance-summary');
        
        const balanceClass = balance.isPositive ? 'balance-positive' : 'balance-negative';
        const balanceIcon = balance.isPositive ? 'bi-emoji-smile' : 'bi-emoji-frown';
        
        balanceSummary.innerHTML = `
          <div class="balance-card ${balanceClass}">
            <div class="balance-title">
              <i class="bi ${balanceIcon}"></i> C√¢n ƒë·ªëi Th√°ng n√†y
            </div>
            <div class="balance-amount">${formatCurrency(balance.balance)}</div>
            <div class="balance-details">
              <div class="balance-income">
                <span>Thu nh·∫≠p</span>
                <span class="balance-income-amount">${formatCurrency(balance.totalIncome)}</span>
              </div>
              <div class="balance-expense">
                <span>Chi ti√™u</span>
                <span class="balance-expense-amount">${formatCurrency(balance.totalExpense)}</span>
              </div>
            </div>
            <div class="balance-savings">
              <span>T·ªâ l·ªá ti·∫øt ki·ªám: <span class="balance-savings-rate">${balance.savingsRate}%</span></span>
            </div>
          </div>
        `;
      })
      .catch(error => {
        console.error('L·ªói khi t·∫£i c√¢n ƒë·ªëi thu chi:', error);
        const balanceSummary = document.getElementById('balance-summary');
        balanceSummary.innerHTML = '<div class="text-center text-muted">Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu c√¢n ƒë·ªëi thu chi</div>';
      });
    }

    // Add income
    function addIncome() {
      // Reset form
      document.getElementById('income-form').reset();
      document.getElementById('income-id').value = '';
      document.getElementById('incomeModalLabel').textContent = 'Th√™m thu nh·∫≠p';
      document.getElementById('income-date').valueAsDate = new Date();
      document.getElementById('frequency-group').style.display = 'none';
      
      // Show modal
      const incomeModal = new bootstrap.Modal(document.getElementById('incomeModal'));
      incomeModal.show();
    }

    // Edit income
    function editIncome(incomeId) {
      fetch(`/api/incomes/${incomeId}`, {
        headers: {
          'Authorization': `Bearer ${token}`
        }
      })
      .then(response => {
        if (!response.ok) throw new Error('Kh√¥ng th·ªÉ t·∫£i th√¥ng tin thu nh·∫≠p');
        return response.json();
      })
      .then(income => {
        document.getElementById('income-id').value = income.id;
        document.getElementById('income-amount').value = income.amount;
        document.getElementById('income-description').value = income.description;
        document.getElementById('income-source').value = income.source;
        document.getElementById('income-date').value = income.date.split('T')[0];
        document.getElementById('income-isRecurring').checked = income.isRecurring;
        
        if (income.isRecurring) {
          document.getElementById('frequency-group').style.display = 'block';
          document.getElementById('income-frequency').value = income.frequency || 'monthly';
        } else {
          document.getElementById('frequency-group').style.display = 'none';
        }
        
        document.getElementById('incomeModalLabel').textContent = 'S·ª≠a thu nh·∫≠p';
        
        const incomeModal = new bootstrap.Modal(document.getElementById('incomeModal'));
        incomeModal.show();
      })
      .catch(error => {
        console.error('L·ªói khi t·∫£i th√¥ng tin thu nh·∫≠p:', error);
        showAlert('danger', 'Kh√¥ng th·ªÉ t·∫£i th√¥ng tin thu nh·∫≠p: ' + error.message);
      });
    }

    // Save income
    function saveIncome() {
      const incomeId = document.getElementById('income-id').value;
      const amount = document.getElementById('income-amount').value;
      const description = document.getElementById('income-description').value;
      const source = document.getElementById('income-source').value;
      const date = document.getElementById('income-date').value;
      const isRecurring = document.getElementById('income-isRecurring').checked;
      const frequency = isRecurring ? document.getElementById('income-frequency').value : null;
      
      // Validate form
      let isValid = true;
      if (!amount || isNaN(amount) || Number(amount) <= 0) {
        document.getElementById('income-amount').classList.add('is-invalid');
        isValid = false;
      } else {
        document.getElementById('income-amount').classList.remove('is-invalid');
      }
      
      if (!description) {
        document.getElementById('income-description').classList.add('is-invalid');
        isValid = false;
      } else {
        document.getElementById('income-description').classList.remove('is-invalid');
      }
      
      if (!date) {
        document.getElementById('income-date').classList.add('is-invalid');
        isValid = false;
      } else {
        document.getElementById('income-date').classList.remove('is-invalid');
      }
      
      if (!source) {
        document.getElementById('income-source').classList.add('is-invalid');
        isValid = false;
      } else {
        document.getElementById('income-source').classList.remove('is-invalid');
      }
      
      if (!isValid) return;
      
      const incomeData = {
        amount,
        description,
        source,
        date,
        isRecurring,
        frequency
      };
      
      const url = incomeId ? `/api/incomes/${incomeId}` : '/api/incomes';
      const method = incomeId ? 'PUT' : 'POST';
      
      fetch(url, {
        method,
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${token}`
        },
        body: JSON.stringify(incomeData)
      })
      .then(response => {
        if (!response.ok) throw new Error('Kh√¥ng th·ªÉ l∆∞u thu nh·∫≠p');
        return response.json();
      })
      .then(data => {
        const incomeModal = bootstrap.Modal.getInstance(document.getElementById('incomeModal'));
        incomeModal.hide();
        
        showAlert('success', incomeId ? 'Thu nh·∫≠p ƒë√£ ƒë∆∞·ª£c c·∫≠p nh·∫≠t' : 'Thu nh·∫≠p ƒë√£ ƒë∆∞·ª£c th√™m');
        loadIncomes();
        loadBalanceSummary();
      })
      .catch(error => {
        console.error('L·ªói khi l∆∞u thu nh·∫≠p:', error);
        showAlert('danger', 'Kh√¥ng th·ªÉ l∆∞u thu nh·∫≠p: ' + error.message);
      });
    }

    // Delete income
    function deleteIncome() {
      const incomeId = document.getElementById('delete-income-id').value;
      
      fetch(`/api/incomes/${incomeId}`, {
        method: 'DELETE',
        headers: {
          'Authorization': `Bearer ${token}`
        }
      })
      .then(response => {
        if (!response.ok) throw new Error('Kh√¥ng th·ªÉ x√≥a thu nh·∫≠p');
        return response.json();
      })
      .then(data => {
        const deleteIncomeModal = bootstrap.Modal.getInstance(document.getElementById('deleteIncomeModal'));
        deleteIncomeModal.hide();
        
        showAlert('success', 'Thu nh·∫≠p ƒë√£ ƒë∆∞·ª£c x√≥a');
        loadIncomes();
        loadBalanceSummary();
      })
      .catch(error => {
        console.error('L·ªói khi x√≥a thu nh·∫≠p:', error);
        showAlert('danger', 'Kh√¥ng th·ªÉ x√≥a thu nh·∫≠p: ' + error.message);
      });
    }

    // Toggle recurring frequency
    function toggleRecurringFrequency() {
      const isRecurring = document.getElementById('income-isRecurring').checked;
      document.getElementById('frequency-group').style.display = isRecurring ? 'block' : 'none';
    }

    // Initialize: load expenses, categories, budgets, incomes and balance summary
    document.addEventListener('DOMContentLoaded', function() {
      const today = new Date().toISOString().split('T')[0];
      document.getElementById('date').value = today;
      
      fetchExpenses();
      fetchCategories();
      loadBudgets();
      loadIncomes();
      loadBalanceSummary();
      
      // Income event listeners
      document.getElementById('add-income-btn').addEventListener('click', addIncome);
      document.getElementById('save-income').addEventListener('click', saveIncome);
      document.getElementById('confirm-delete-income').addEventListener('click', deleteIncome);
      document.getElementById('income-isRecurring').addEventListener('change', toggleRecurringFrequency);
    });
  </script>
</body>
</html>
