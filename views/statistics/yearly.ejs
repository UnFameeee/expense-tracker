<div class="dashboard-summary">
    <div class="summary-card" style="background-color: #fff;">
        <div class="icon" style="background-color: #4361ee;">
            <i class="fas fa-calendar"></i>
        </div>
        <div class="info">
            <h3><%= new Intl.NumberFormat('vi-VN').format(total) %> VND</h3>
            <p>Chi ti√™u nƒÉm <%= year %></p>
        </div>
    </div>
    <div class="summary-card" style="background-color: #fff;">
        <div class="icon" style="background-color: #38b000;">
            <i class="fas fa-receipt"></i>
        </div>
        <div class="info">
            <h3><%= expenses.length %></h3>
            <p>S·ªë kho·∫£n chi ti√™u</p>
        </div>
    </div>
    <div class="summary-card" style="background-color: #fff;">
        <div class="icon" style="background-color: #e63946;">
            <i class="fas fa-chart-line"></i>
        </div>
        <div class="info">
            <h3><%= new Intl.NumberFormat('vi-VN').format(total / 12) %> VND</h3>
            <p>Trung b√¨nh m·ªói th√°ng</p>
        </div>
    </div>
</div>

<div class="card">
    <div class="card-header">
        <h2><i class="fas fa-chart-pie"></i> Th·ªëng k√™ chi ti√™u theo nƒÉm</h2>
        <div class="stats-nav">
            <a href="/statistics" class="btn"><i class="fas fa-chart-bar"></i> T·ªïng quan</a>
            <a href="/statistics/daily" class="btn"><i class="fas fa-calendar-day"></i> Ng√†y</a>
            <a href="/statistics/weekly" class="btn"><i class="fas fa-calendar-week"></i> Tu·∫ßn</a>
            <a href="/statistics/monthly" class="btn"><i class="fas fa-calendar-alt"></i> Th√°ng</a>
            <a href="/statistics/yearly" class="btn btn-primary"><i class="fas fa-calendar"></i> NƒÉm</a>
        </div>
    </div>

    <div class="year-selector">
        <form action="/statistics/yearly" method="GET">
            <div class="form-group">
                <label for="year"><i class="fas fa-calendar-year"></i> Ch·ªçn nƒÉm:</label>
                <select id="year" name="year" onchange="this.form.submit()">
                    <% for(let y = new Date().getFullYear(); y >= 2020; y--) { %>
                        <option value="<%= y %>" <%= year === y ? 'selected' : '' %>><%= y %></option>
                    <% } %>
                </select>
            </div>
        </form>
    </div>

    <% if (expenses.length > 0) { %>
        <div class="stats-overview">
            <div class="chart-container">
                <h3>Chi ti√™u theo th√°ng trong nƒÉm</h3>
                <canvas id="monthlyChart"></canvas>
            </div>

            <div class="category-distribution">
                <h3>Ph√¢n b·ªë chi ti√™u theo danh m·ª•c</h3>
                <% if (categoryTotals && categoryTotals.length > 0) { %>
                    <div class="pie-chart-container">
                        <canvas id="categoryPieChart"></canvas>
                    </div>
                    <div class="category-list">
                        <% categoryTotals.forEach(category => { %>
                            <div class="category-item">
                                <div class="category-name">
                                    <span class="category-badge">
                                        <% if (category.category === 'ƒÇn u·ªëng') { %>
                                            üçï
                                        <% } else if (category.category === 'Di chuy·ªÉn') { %>
                                            üöó
                                        <% } else if (category.category === 'Mua s·∫Øm') { %>
                                            üõí
                                        <% } else if (category.category === 'H√≥a ƒë∆°n') { %>
                                            üìÑ
                                        <% } else if (category.category === 'Gi·∫£i tr√≠') { %>
                                            üéÆ
                                        <% } else { %>
                                            üìå
                                        <% } %>
                                        <%= category.category %>
                                    </span>
                                </div>
                                <div class="category-amount"><%= new Intl.NumberFormat('vi-VN').format(category.total) %> VND</div>
                                <div class="category-percent"><%= ((category.total / total) * 100).toFixed(1) %>%</div>
                            </div>
                        <% }); %>
                    </div>
                <% } else { %>
                    <p class="no-data">Kh√¥ng c√≥ d·ªØ li·ªáu danh m·ª•c cho nƒÉm n√†y</p>
                <% } %>
            </div>
        </div>

        <div class="expenses-list">
            <h3>Chi ti√™u cao nh·∫•t trong nƒÉm</h3>
            <table class="expense-table">
                <thead>
                    <tr>
                        <th>Ng√†y</th>
                        <th>M√¥ t·∫£</th>
                        <th>Danh m·ª•c</th>
                        <th>S·ªë ti·ªÅn</th>
                    </tr>
                </thead>
                <tbody>
                    <% expenses.sort((a, b) => parseFloat(b.amount) - parseFloat(a.amount)).slice(0, 10).forEach(expense => { %>
                        <tr>
                            <td><%= new Date(expense.date).toLocaleDateString('vi-VN') %></td>
                            <td><%= expense.description %></td>
                            <td>
                                <span class="category-badge">
                                    <% if (expense.category === 'ƒÇn u·ªëng') { %>
                                        üçï
                                    <% } else if (expense.category === 'Di chuy·ªÉn') { %>
                                        üöó
                                    <% } else if (expense.category === 'Mua s·∫Øm') { %>
                                        üõí
                                    <% } else if (expense.category === 'H√≥a ƒë∆°n') { %>
                                        üìÑ
                                    <% } else if (expense.category === 'Gi·∫£i tr√≠') { %>
                                        üéÆ
                                    <% } else { %>
                                        üìå
                                    <% } %>
                                    <%= expense.category %>
                                </span>
                            </td>
                            <td class="amount"><%= expense.amount %></td>
                        </tr>
                    <% }); %>
                </tbody>
            </table>
        </div>
    <% } else { %>
        <div class="empty-message">
            <i class="fas fa-calendar"></i>
            <p>Kh√¥ng c√≥ chi ti√™u n√†o trong nƒÉm <%= year %></p>
            <a href="/expenses/new" class="btn btn-primary"><i class="fas fa-plus-circle"></i> Th√™m chi ti√™u m·ªõi</a>
        </div>
    <% } %>
</div>

<% if (expenses.length > 0) { %>
<script>
    // Bi·ªÉu ƒë·ªì chi ti√™u theo th√°ng trong nƒÉm
    const monthlyCtx = document.getElementById('monthlyChart').getContext('2d');
    const monthlyData = <%= chartData %>;
    
    new Chart(monthlyCtx, {
        type: 'bar',
        data: monthlyData,
        options: {
            scales: {
                y: {
                    beginAtZero: true
                }
            },
            responsive: true,
            maintainAspectRatio: false
        }
    });
    
    <% if (categoryTotals && categoryTotals.length > 0) { %>
    // Bi·ªÉu ƒë·ªì ph√¢n b·ªë chi ti√™u theo danh m·ª•c
    const categoryCtx = document.getElementById('categoryPieChart').getContext('2d');
    const categoryData = {
        labels: [<% categoryTotals.forEach(category => { %>'<%= category.category %>', <% }); %>],
        datasets: [{
            data: [<% categoryTotals.forEach(category => { %><%= category.total %>, <% }); %>],
            backgroundColor: [
                'rgba(255, 99, 132, 0.7)',
                'rgba(54, 162, 235, 0.7)',
                'rgba(255, 206, 86, 0.7)',
                'rgba(75, 192, 192, 0.7)',
                'rgba(153, 102, 255, 0.7)',
                'rgba(255, 159, 64, 0.7)',
                'rgba(201, 203, 207, 0.7)'
            ],
            borderWidth: 1
        }]
    };
    
    new Chart(categoryCtx, {
        type: 'doughnut',
        data: categoryData,
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'right',
                }
            }
        }
    });
    <% } %>
</script>
<% } %>

<style>
    .year-selector {
        margin: 1.5rem 0;
        padding: 1rem;
        background-color: #f8fafc;
        border-radius: var(--border-radius);
    }
    
    .year-selector .form-group {
        display: flex;
        align-items: center;
        gap: 1rem;
    }
    
    .year-selector label {
        font-weight: 500;
        color: var(--dark-color);
        margin-bottom: 0;
    }
    
    .year-selector select {
        padding: 0.5rem 1rem;
        border: 1px solid #e2e8f0;
        border-radius: var(--border-radius);
        background-color: white;
    }
    
    .stats-nav {
        display: flex;
        gap: 0.5rem;
    }
    
    .stats-overview {
        display: flex;
        flex-wrap: wrap;
        gap: 2rem;
        margin-top: 2rem;
    }
    
    .chart-container {
        flex: 1;
        min-width: 300px;
        height: 300px;
    }
    
    .category-distribution {
        flex: 1;
        min-width: 300px;
    }
    
    .pie-chart-container {
        height: 250px;
        margin-bottom: 1.5rem;
    }
    
    .category-list {
        max-height: 300px;
        overflow-y: auto;
    }
    
    .category-item {
        display: flex;
        justify-content: space-between;
        padding: 0.75rem 0;
        border-bottom: 1px solid #e2e8f0;
    }
    
    .category-name {
        flex: 2;
    }
    
    .category-amount {
        flex: 1;
        text-align: right;
    }
    
    .category-percent {
        flex: 0 0 60px;
        text-align: right;
        font-weight: 500;
    }
    
    .expenses-list {
        margin-top: 2rem;
    }
    
    h3 {
        margin-bottom: 1.5rem;
        color: var(--dark-color);
        font-size: 1.2rem;
    }
    
    .no-data {
        color: var(--text-muted);
        text-align: center;
        padding: 2rem 0;
    }
    
    @media (max-width: 768px) {
        .stats-nav {
            flex-wrap: wrap;
        }
        
        .stats-overview {
            flex-direction: column;
        }
        
        .year-selector .form-group {
            flex-direction: column;
            align-items: flex-start;
        }
    }
</style>
